<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Flonze</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">üöö Flonze</div>
      <ul class="nav-menu">
        <li><a href="home.html">Home</a></li>
        <li><a href="booking.html">Book Now</a></li>
        <li><a href="tracking.html">Track</a></li>
        <li><a href="dashboard.html" class="active">Dashboard</a></li>
      </ul>
      <div class="user-menu">
        <span id="userName">John Doe</span>
        <button onclick="logout()" class="btn-secondary">Logout</button>
      </div>
    </div>
  </nav>

  <div class="dashboard-page">
    <div class="container">
      <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="dashboard-sidebar">
          <div class="user-profile">
            <div class="profile-avatar">üë§</div>
            <h3 id="profileName">John Doe</h3>
            <p id="profileEmail">john@example.com</p>
          </div>
          
          <nav class="dashboard-nav">
            <a href="#" onclick="showSection('orders')" class="nav-item active">
              üì¶ My Orders
            </a>
            <a href="#" onclick="showSection('profile')" class="nav-item">
              üë§ Profile
            </a>
            <a href="#" onclick="showSection('addresses')" class="nav-item">
              üìç Saved Addresses
            </a>
            <a href="#" onclick="showSection('payments')" class="nav-item">
              üí≥ Payment Methods
            </a>
            <a href="#" onclick="showSection('referrals')" class="nav-item">
              üéÅ Referrals
            </a>
          </nav>
        </div>

        <!-- Main Content -->
        <div class="dashboard-content">
          <!-- Orders Section -->
          <div id="ordersSection" class="content-section active">
            <div class="section-header">
              <h2>My Orders</h2>
              <div class="order-filters">
                <button onclick="filterOrders('all')" class="filter-btn active">All</button>
                <button onclick="filterOrders('active')" class="filter-btn">Active</button>
                <button onclick="filterOrders('completed')" class="filter-btn">Completed</button>
                <button onclick="filterOrders('cancelled')" class="filter-btn">Cancelled</button>
              </div>
            </div>

            <div class="orders-list" id="ordersList">
              <!-- Order items will be loaded here -->
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profileSection" class="content-section">
            <div class="section-header">
              <h2>Profile Settings</h2>
            </div>
            
            <form class="profile-form" onsubmit="updateProfile(event)">
              <div class="form-row">
                <div class="form-group">
                  <label>Full Name</label>
                  <input type="text" id="fullName" value="John Doe" required>
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="email" value="john@example.com" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Phone Number</label>
                  <input type="tel" id="phone" value="+91 9876543210" required>
                </div>
                <div class="form-group">
                  <label>Date of Birth</label>
                  <input type="date" id="dob" value="1990-01-01">
                </div>
              </div>
              <button type="submit" class="btn-primary">Update Profile</button>
            </form>

            <div class="password-section">
              <h3>Change Password</h3>
              <form class="password-form" onsubmit="changePassword(event)">
                <div class="form-group">
                  <label>Current Password</label>
                  <input type="password" id="currentPassword" required>
                </div>
                <div class="form-group">
                  <label>New Password</label>
                  <input type="password" id="newPassword" required>
                </div>
                <div class="form-group">
                  <label>Confirm New Password</label>
                  <input type="password" id="confirmPassword" required>
                </div>
                <button type="submit" class="btn-secondary">Change Password</button>
              </form>
            </div>
          </div>

          <!-- Addresses Section -->
          <div id="addressesSection" class="content-section">
            <div class="section-header">
              <h2>Saved Addresses</h2>
              <button onclick="addNewAddress()" class="btn-primary">+ Add New Address</button>
            </div>
            
            <div class="addresses-list" id="addressesList">
              <!-- Addresses will be loaded here -->
            </div>
          </div>

          <!-- Payment Methods Section -->
          <div id="paymentsSection" class="content-section">
            <div class="section-header">
              <h2>Payment Methods</h2>
              <button onclick="addPaymentMethod()" class="btn-primary">+ Add Payment Method</button>
            </div>
            
            <div class="payment-methods" id="paymentMethodsList">
              <!-- Payment methods will be loaded here -->
            </div>
          </div>

          <!-- Referrals Section -->
          <div id="referralsSection" class="content-section">
            <div class="section-header">
              <h2>Referral Program</h2>
            </div>
            
            <div class="referral-card">
              <h3>Refer Friends & Earn</h3>
              <p>Share your referral code and earn ‚Çπ50 for each successful referral!</p>
              
              <div class="referral-code">
                <label>Your Referral Code</label>
                <div class="code-container">
                  <input type="text" value="JOHN2025" readonly id="referralCode">
                  <button onclick="copyReferralCode()" class="btn-secondary">Copy</button>
                </div>
              </div>
              
              <div class="referral-stats">
                <div class="stat">
                  <span class="stat-number">12</span>
                  <span class="stat-label">Total Referrals</span>
                </div>
                <div class="stat">
                  <span class="stat-number">‚Çπ600</span>
                  <span class="stat-label">Earned</span>
                </div>
                <div class="stat">
                  <span class="stat-number">‚Çπ150</span>
                  <span class="stat-label">Pending</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div id="orderModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="orderDetails"></div>
    </div>
  </div>

  <script>
    let currentOrders = [];

    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadUserProfile();
      loadOrders();
      loadAddresses();
      loadPaymentMethods();
    });

    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Remove active class from nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected section
      document.getElementById(sectionName + 'Section').classList.add('active');
      event.target.classList.add('active');
    }

    async function loadUserProfile() {
      try {
        const response = await fetch('/api/profile', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });
        
        if (response.ok) {
          const user = await response.json();
          document.getElementById('userName').textContent = user.name;
          document.getElementById('profileName').textContent = user.name;
          document.getElementById('profileEmail').textContent = user.email;
          document.getElementById('fullName').value = user.name;
          document.getElementById('email').value = user.email;
          document.getElementById('phone').value = user.phone || '';
        }
      } catch (error) {
        console.error('Failed to load profile:', error);
      }
    }

    async function loadOrders() {
      try {
        const response = await fetch('/api/bookings', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });
        
        if (response.ok) {
          currentOrders = await response.json();
          displayOrders(currentOrders);
        }
      } catch (error) {
        // Mock data for demonstration
        currentOrders = [
          {
            _id: '1',
            trackingId: 'FL1234567890',
            pickupLocation: { address: 'Connaught Place, Delhi' },
            dropLocation: { address: 'India Gate, Delhi' },
            fare: 150,
            status: 'delivered',
            createdAt: '2025-01-15T10:30:00Z',
            packageDetails: { weight: 2.5, type: 'Electronics' }
          },
          {
            _id: '2',
            trackingId: 'FL1234567891',
            pickupLocation: { address: 'Karol Bagh, Delhi' },
            dropLocation: { address: 'Lajpat Nagar, Delhi' },
            fare: 120,
            status: 'in_transit',
            createdAt: '2025-01-15T14:15:00Z',
            packageDetails: { weight: 1.2, type: 'Documents' }
          }
        ];
        displayOrders(currentOrders);
      }
    }

    function displayOrders(orders) {
      const ordersList = document.getElementById('ordersList');
      
      if (orders.length === 0) {
        ordersList.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <h3>No orders found</h3>
            <p>You haven't placed any orders yet.</p>
            <a href="booking.html" class="btn-primary">Book Your First Delivery</a>
          </div>
        `;
        return;
      }

      ordersList.innerHTML = orders.map(order => `
        <div class="order-item" onclick="showOrderDetails('${order._id}')">
          <div class="order-header">
            <div class="order-id">${order.trackingId}</div>
            <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
          </div>
          <div class="order-route">
            <div class="route-point">
              <span class="route-icon">üìç</span>
              <span class="route-address">${order.pickupLocation.address}</span>
            </div>
            <div class="route-arrow">‚Üí</div>
            <div class="route-point">
              <span class="route-icon">üèÅ</span>
              <span class="route-address">${order.dropLocation.address}</span>
            </div>
          </div>
          <div class="order-details">
            <span class="order-date">${formatDate(order.createdAt)}</span>
            <span class="order-fare">‚Çπ${order.fare}</span>
          </div>
          <div class="order-actions">
            <button onclick="trackOrder('${order.trackingId}')" class="btn-secondary btn-small">Track</button>
            <button onclick="downloadInvoice('${order._id}')" class="btn-secondary btn-small">Invoice</button>
          </div>
        </div>
      `).join('');
    }

    function filterOrders(filter) {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      let filteredOrders = currentOrders;
      
      if (filter !== 'all') {
        filteredOrders = currentOrders.filter(order => {
          if (filter === 'active') return ['pending', 'assigned', 'picked_up', 'in_transit'].includes(order.status);
          if (filter === 'completed') return order.status === 'delivered';
          if (filter === 'cancelled') return order.status === 'cancelled';
          return true;
        });
      }
      
      displayOrders(filteredOrders);
    }

    function loadAddresses() {
      const addressesList = document.getElementById('addressesList');
      
      // Mock addresses
      const addresses = [
        { id: 1, name: 'Home', address: '123 Main Street, Delhi', isDefault: true },
        { id: 2, name: 'Office', address: '456 Business Park, Gurgaon', isDefault: false }
      ];
      
      addressesList.innerHTML = addresses.map(addr => `
        <div class="address-item">
          <div class="address-info">
            <h4>${addr.name} ${addr.isDefault ? '<span class="default-badge">Default</span>' : ''}</h4>
            <p>${addr.address}</p>
          </div>
          <div class="address-actions">
            <button onclick="editAddress(${addr.id})" class="btn-secondary btn-small">Edit</button>
            <button onclick="deleteAddress(${addr.id})" class="btn-danger btn-small">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function loadPaymentMethods() {
      const paymentMethodsList = document.getElementById('paymentMethodsList');
      
      // Mock payment methods
      const paymentMethods = [
        { id: 1, type: 'card', last4: '1234', brand: 'Visa', isDefault: true },
        { id: 2, type: 'upi', id: 'john@paytm', isDefault: false }
      ];
      
      paymentMethodsList.innerHTML = paymentMethods.map(method => `
        <div class="payment-method-item">
          <div class="payment-info">
            <div class="payment-icon">${method.type === 'card' ? 'üí≥' : 'üì±'}</div>
            <div class="payment-details">
              <h4>${method.type === 'card' ? `${method.brand} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${method.last4}` : method.id}</h4>
              ${method.isDefault ? '<span class="default-badge">Default</span>' : ''}
            </div>
          </div>
          <div class="payment-actions">
            <button onclick="editPaymentMethod(${method.id})" class="btn-secondary btn-small">Edit</button>
            <button onclick="deletePaymentMethod(${method.id})" class="btn-danger btn-small">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function getStatusText(status) {
      const statusMap = {
        'pending': 'Pending',
        'assigned': 'Driver Assigned',
        'picked_up': 'Picked Up',
        'in_transit': 'In Transit',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
      };
      return statusMap[status] || status;
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-IN', {
        day: 'numeric',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function trackOrder(trackingId) {
      window.location.href = `tracking.html?id=${trackingId}`;
    }

    function downloadInvoice(orderId) {
      // Simulate invoice download
      alert('Invoice download will be available soon!');
    }

    function copyReferralCode() {
      const codeInput = document.getElementById('referralCode');
      codeInput.select();
      document.execCommand('copy');
      alert('Referral code copied to clipboard!');
    }

    function updateProfile(event) {
      event.preventDefault();
      alert('Profile updated successfully!');
    }

    function changePassword(event) {
      event.preventDefault();
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (newPassword !== confirmPassword) {
        alert('Passwords do not match!');
        return;
      }
      
      alert('Password changed successfully!');
    }

    function addNewAddress() {
      alert('Add address feature will be available soon!');
    }

    function addPaymentMethod() {
      alert('Add payment method feature will be available soon!');
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'home.html';
    }

    function closeModal() {
      document.getElementById('orderModal').style.display = 'none';
    }
  </script>
</body>
</html>