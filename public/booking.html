<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Delivery - Flonze</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">üöö Flonze</div>
      <ul class="nav-menu">
        <li><a href="home.html">Home</a></li>
        <li><a href="booking.html" class="active">Book Now</a></li>
        <li><a href="tracking.html">Track</a></li>
        <li><a href="dashboard.html">Dashboard</a></li>
      </ul>
    </div>
  </nav>

  <div class="booking-page">
    <div class="container">
      <div class="booking-container">
        <div class="booking-form-section">
          <h1>Book Your Delivery</h1>
          <form class="detailed-booking-form" onsubmit="submitBooking(event)">
            <!-- Location Section -->
            <div class="form-section">
              <h3>üìç Pickup & Drop Locations</h3>
              <div class="location-inputs">
                <div class="location-input">
                  <label>Pickup Location</label>
                  <input type="text" id="pickupLocation" placeholder="Enter pickup address" required>
                  <button type="button" onclick="getCurrentLocation('pickup')" class="location-btn">üìç Use Current Location</button>
                </div>
                <div class="location-input">
                  <label>Drop Location</label>
                  <input type="text" id="dropLocation" placeholder="Enter drop address" required>
                </div>
              </div>
            </div>

            <!-- Package Details -->
            <div class="form-section">
              <h3>üì¶ Package Details</h3>
              <div class="package-details">
                <div class="form-row">
                  <div class="form-group">
                    <label>Weight (kg)</label>
                    <input type="number" id="packageWeight" min="0.1" step="0.1" placeholder="0.5" required>
                  </div>
                  <div class="form-group">
                    <label>Package Size</label>
                    <select id="packageSize" required>
                      <option value="">Select Size</option>
                      <option value="small">Small (up to 30cm)</option>
                      <option value="medium">Medium (30-60cm)</option>
                      <option value="large">Large (60-100cm)</option>
                      <option value="xl">Extra Large (100cm+)</option>
                    </select>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Package Type</label>
                    <select id="packageType" required>
                      <option value="">Select Type</option>
                      <option value="documents">Documents</option>
                      <option value="electronics">Electronics</option>
                      <option value="clothing">Clothing</option>
                      <option value="food">Food Items</option>
                      <option value="fragile">Fragile Items</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Special Instructions</label>
                    <input type="text" id="instructions" placeholder="Handle with care, etc.">
                  </div>
                </div>
              </div>
            </div>

            <!-- Vehicle Selection -->
            <div class="form-section">
              <h3>üöó Choose Vehicle</h3>
              <div class="vehicle-options">
                <div class="vehicle-option" onclick="selectVehicle('bike')">
                  <div class="vehicle-icon">üèçÔ∏è</div>
                  <div class="vehicle-info">
                    <h4>Bike</h4>
                    <p>Up to 5kg ‚Ä¢ ‚Çπ8/km</p>
                    <span class="delivery-time">30-60 mins</span>
                  </div>
                </div>
                <div class="vehicle-option" onclick="selectVehicle('auto')">
                  <div class="vehicle-icon">üõ∫</div>
                  <div class="vehicle-info">
                    <h4>Auto Rickshaw</h4>
                    <p>Up to 20kg ‚Ä¢ ‚Çπ12/km</p>
                    <span class="delivery-time">45-90 mins</span>
                  </div>
                </div>
                <div class="vehicle-option" onclick="selectVehicle('mini')">
                  <div class="vehicle-icon">üöê</div>
                  <div class="vehicle-info">
                    <h4>Mini Truck</h4>
                    <p>Up to 100kg ‚Ä¢ ‚Çπ15/km</p>
                    <span class="delivery-time">1-2 hours</span>
                  </div>
                </div>
                <div class="vehicle-option" onclick="selectVehicle('sedan')">
                  <div class="vehicle-icon">üöó</div>
                  <div class="vehicle-info">
                    <h4>Sedan</h4>
                    <p>Up to 50kg ‚Ä¢ ‚Çπ18/km</p>
                    <span class="delivery-time">1-2 hours</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Contact Details -->
            <div class="form-section">
              <h3>üìû Contact Details</h3>
              <div class="form-row">
                <div class="form-group">
                  <label>Sender Name</label>
                  <input type="text" id="senderName" required>
                </div>
                <div class="form-group">
                  <label>Sender Phone</label>
                  <input type="tel" id="senderPhone" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Receiver Name</label>
                  <input type="text" id="receiverName" required>
                </div>
                <div class="form-group">
                  <label>Receiver Phone</label>
                  <input type="tel" id="receiverPhone" required>
                </div>
              </div>
            </div>

            <button type="submit" class="btn-primary btn-large">Confirm Booking</button>
          </form>
        </div>

        <!-- Fare Calculator & Map -->
        <div class="booking-sidebar">
          <div class="fare-calculator">
            <h3>Fare Breakdown</h3>
            <div class="fare-details">
              <div class="fare-item">
                <span>Distance:</span>
                <span id="totalDistance">-- km</span>
              </div>
              <div class="fare-item">
                <span>Base Fare:</span>
                <span id="baseFare">‚Çπ--</span>
              </div>
              <div class="fare-item">
                <span>Weight Charge:</span>
                <span id="weightCharge">‚Çπ--</span>
              </div>
              <div class="fare-item total">
                <span>Total Fare:</span>
                <span id="totalFare">‚Çπ--</span>
              </div>
            </div>
            <div class="payment-methods">
              <h4>Payment Method</h4>
              <label><input type="radio" name="payment" value="cod" checked> Cash on Delivery</label>
              <label><input type="radio" name="payment" value="online"> Pay Online</label>
            </div>
          </div>

          <div class="route-map">
            <h3>Route Preview</h3>
            <div id="map" style="height: 300px; border-radius: 8px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Confirmation Modal -->
  <div id="confirmationModal" class="modal">
    <div class="modal-content">
      <div class="confirmation-content">
        <div class="success-icon">‚úÖ</div>
        <h2>Booking Confirmed!</h2>
        <p>Your delivery has been booked successfully.</p>
        <div class="booking-details">
          <p><strong>Tracking ID:</strong> <span id="trackingId"></span></p>
          <p><strong>Estimated Delivery:</strong> <span id="estimatedTime"></span></p>
        </div>
        <div class="confirmation-actions">
          <button onclick="trackOrder()" class="btn-primary">Track Order</button>
          <button onclick="closeModal()" class="btn-secondary">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let map, directionsService, directionsRenderer;
    let selectedVehicle = null;
    let pickupCoords = null;
    let dropCoords = null;

    // Initialize Google Maps
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: { lat: 28.6139, lng: 77.2090 } // Delhi
      });
      
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer();
      directionsRenderer.setMap(map);

      // Initialize autocomplete
      const pickupInput = document.getElementById('pickupLocation');
      const dropInput = document.getElementById('dropLocation');
      
      const pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput);
      const dropAutocomplete = new google.maps.places.Autocomplete(dropInput);

      pickupAutocomplete.addListener('place_changed', () => {
        const place = pickupAutocomplete.getPlace();
        if (place.geometry) {
          pickupCoords = {
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
          };
          calculateRoute();
        }
      });

      dropAutocomplete.addListener('place_changed', () => {
        const place = dropAutocomplete.getPlace();
        if (place.geometry) {
          dropCoords = {
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
          };
          calculateRoute();
        }
      });
    }

    function calculateRoute() {
      if (pickupCoords && dropCoords) {
        directionsService.route({
          origin: pickupCoords,
          destination: dropCoords,
          travelMode: google.maps.TravelMode.DRIVING
        }, (result, status) => {
          if (status === 'OK') {
            directionsRenderer.setDirections(result);
            const distance = result.routes[0].legs[0].distance.value / 1000; // km
            updateFareCalculation(distance);
          }
        });
      }
    }

    function updateFareCalculation(distance) {
      const weight = parseFloat(document.getElementById('packageWeight').value) || 0;
      
      if (selectedVehicle && distance > 0) {
        const rates = { bike: 8, auto: 12, mini: 15, sedan: 18 };
        const baseFare = rates[selectedVehicle] * distance;
        const weightCharge = weight > 5 ? (weight - 5) * 2 : 0;
        const totalFare = Math.ceil(baseFare + weightCharge);

        document.getElementById('totalDistance').textContent = distance.toFixed(1) + ' km';
        document.getElementById('baseFare').textContent = '‚Çπ' + Math.ceil(baseFare);
        document.getElementById('weightCharge').textContent = '‚Çπ' + weightCharge;
        document.getElementById('totalFare').textContent = '‚Çπ' + totalFare;
      }
    }

    function selectVehicle(type) {
      document.querySelectorAll('.vehicle-option').forEach(el => el.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      selectedVehicle = type;
      
      const distance = parseFloat(document.getElementById('totalDistance').textContent) || 0;
      if (distance > 0) {
        updateFareCalculation(distance);
      }
    }

    function getCurrentLocation(type) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const coords = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ location: coords }, (results, status) => {
            if (status === 'OK' && results[0]) {
              document.getElementById(type + 'Location').value = results[0].formatted_address;
              if (type === 'pickup') {
                pickupCoords = coords;
              }
              calculateRoute();
            }
          });
        });
      }
    }

    async function submitBooking(event) {
      event.preventDefault();
      
      if (!selectedVehicle) {
        alert('Please select a vehicle type');
        return;
      }

      const bookingData = {
        pickupLocation: {
          address: document.getElementById('pickupLocation').value,
          lat: pickupCoords?.lat,
          lng: pickupCoords?.lng
        },
        dropLocation: {
          address: document.getElementById('dropLocation').value,
          lat: dropCoords?.lat,
          lng: dropCoords?.lng
        },
        packageDetails: {
          weight: parseFloat(document.getElementById('packageWeight').value),
          size: document.getElementById('packageSize').value,
          type: document.getElementById('packageType').value
        },
        vehicleType: selectedVehicle,
        fare: parseInt(document.getElementById('totalFare').textContent.replace('‚Çπ', '')),
        senderName: document.getElementById('senderName').value,
        senderPhone: document.getElementById('senderPhone').value,
        receiverName: document.getElementById('receiverName').value,
        receiverPhone: document.getElementById('receiverPhone').value
      };

      try {
        const response = await fetch('/api/booking', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify(bookingData)
        });

        const result = await response.json();
        if (response.ok) {
          document.getElementById('trackingId').textContent = result.trackingId;
          document.getElementById('estimatedTime').textContent = '30-60 minutes';
          document.getElementById('confirmationModal').style.display = 'block';
        } else {
          alert('Booking failed: ' + result.error);
        }
      } catch (error) {
        alert('Booking failed. Please try again.');
      }
    }

    function trackOrder() {
      const trackingId = document.getElementById('trackingId').textContent;
      window.location.href = `tracking.html?id=${trackingId}`;
    }

    function closeModal() {
      document.getElementById('confirmationModal').style.display = 'none';
    }

    // Initialize map when page loads
    window.onload = initMap;
  </script>
</body>
</html>